<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üó∫Ô∏è LFMWB Landscape Fire Management Projects Map</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<style>
  :root { --green:#2E8B57; --green2:#228B22; --bg1:#f5f7fa; --bg2:#c3cfe2; --orange: #F0A500; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%)}
  /* Header Styling */
  .header{background:linear-gradient(135deg,var(--green) 0%,var(--green2) 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,1)}
  .header h1{margin:0;font-size:28px}
  .header p{margin:6px 0 0;opacity:.95}
  /* Layout Styling */
  .main{display:flex;gap:20px;padding:20px;height:calc(100vh - 120px)}
  .panel{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
  .map-wrap{position:relative;flex:2;overflow:hidden;display:flex;min-height:520px;height:100%}
  #map{flex:1;min-height:520px;width:100%;background:#eef3f7}
  .sidebar{flex:1;display:flex;flex-direction:column;gap:16px;overflow:auto;max-height:calc(100vh - 160px);padding:16px}
  /* UI Elements */
  .card{padding:16px}
  .card h3{margin:0 0 10px;color:var(--green);border-bottom:2px solid var(--green);padding-bottom:8px}
  .loc{background:#f8f9fa;border-left:4px solid var(--green);border-radius:10px;padding:12px;margin-bottom:12px;cursor:pointer;transition:.25s}
  .loc:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
  .loc.active{background:#e8f5e8;border-left-color:var(--green2)}
  .loc .t{font-weight:bold;margin-bottom:4px}
  .loc .d{display:inline-block;font-size:12px;background:var(--green);color:#fff;padding:3px 8px;border-radius:4px;margin:4px 0 8px}
  .loc.cross-border .d{background: var(--orange)}
  .loc .org{font-size:12px;color:#444;line-height:1.4}
  .loc.cross-border{border-left-color: var(--orange)}
  .controls{position:absolute;top:10px;right:10px;z-index:999;background:#fff;padding:8px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .controls button{background:var(--green);color:#fff;border:0;padding:7px 10px;border-radius:4px;margin:2px;font-size:12px;cursor:pointer}
  .controls button:hover{background:var(--green2)}
  /* Pop-up Styling */
  .popup .title{font-weight:bold;color:var(--green);margin-bottom:4px; font-size: 16px;}
  .popup .subtitle{font-style: italic; font-size: 13px; color: #555; margin-bottom: 5px;}
  .popup .details{font-size: 12px;}
  .popup ul{margin:6px 0 0 18px;padding:0; list-style-type: disc;}
  .popup li{margin:3px 0;}
  .popup strong{color:#333;}
  .leaflet-popup-content {
    max-width: 350px !important;
  }
  /* Draggable Popup Handle */
  .leaflet-popup-content-wrapper {
      cursor: grab; 
  }
  .leaflet-popup-content-wrapper:active {
      cursor: grabbing; 
  }

  /* Custom Icon Styling for Initials */
  .country-marker {
    display: block;
    width: 40px;
    height: 60px;
    text-align: center;
    position: relative;
  }
  .country-marker .initials {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0,0,0,0.8);
    color: white;
    font-size: 10px;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
    z-index: 100;
    white-space: nowrap;
  }
  .country-marker .badge {
    position: absolute;
    top: 15px; 
    left: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 3px 10px rgba(0,0,0,.3);
  }

  /* Responsive Design */
  @media (max-width: 900px){
    .main{flex-direction:column;height:auto}
    .map-wrap{height:420px;min-height:420px}
    #map{min-height:420px}
    .sidebar{max-height:none}
  }
</style>
</head>
<body>
  <div class="header">
    <h1>üó∫Ô∏è LFMWB Landscape Fire Management Projects</h1>
    <p>Interactive Projects Map in the Western Balkans</p>
  </div>

  <div class="main">
    <div class="panel map-wrap">
      <div id="map"></div>
      <div class="controls">
        <button onclick="fitAll()">Fit All Markers</button>
      </div>
    </div>

    <div class="panel sidebar">
      <div class="card">
        <h3>üìç Project List (Click to view on map)</h3>
        <div id="project-list"></div>
      </div>
      
      <div class="card">
        <h3>üí° Legend</h3>
        <div class="loc" style="background:#fff;border-left: 4px solid #2E8B57;margin-bottom:8px">
          <div class="t" style="color:#2E8B57;">‚û°Ô∏è Single-Country Project</div>
          <div class="org small">Project implemented exclusively within one country's borders.</div>
        </div>
        <div class="loc" style="background:#fff;border-left: 4px solid #F0A500;margin-bottom:0;">
          <div class="t" style="color:#F0A500;">ü§ù Cross-Border Project</div>
          <div class="org small">Project involving cooperation between two countries.</div>
        </div>
        <div class="loc" style="background:#fff;border-left: 4px solid #00BFFF;margin-top:10px;">
          <div class="t" style="color:#00BFFF;">üîµ Blue Circle Delineation</div>
          <div class="org small">Represents the **Estimated Area of Interest** for the project (not exact administrative boundaries).</div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
  // ** Leaflet Draggable Popup Fix V4 (Final reliable version) **
  // This function ensures the popup can be dragged accurately after it opens.
  function makePopupDraggable(e) {
      var popup = e.popup;
      var map = e.target._map;
      var container = popup._container;
      var wrapper = container.querySelector('.leaflet-popup-content-wrapper');

      if (!wrapper) return; 

      var originalLatLng = popup.getLatLng();
      var moved = false;

      // Start drag listener on the wrapper
      L.DomEvent.on(wrapper, 'mousedown', function(e) {
          if (e.button !== 0) return; 

          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableMapSensors(); 
          L.DomEvent.preventDefault(e);

          moved = false;
          var startPoint = new L.Point(e.clientX, e.clientY);
          
          function onMove(e) {
              moved = true;
              var dx = e.clientX - startPoint.x;
              var dy = e.clientY - startPoint.y;
              container.style.transform = 'translate3d(' + dx + 'px, ' + dy + 'px, 0)';
          }

          function onUp(e) {
              L.DomEvent.enableMapSensors();
              L.DomEvent.off(document, 'mousemove', onMove);
              L.DomEvent.off(document, 'mouseup', onUp);

              if (moved) {
                  var dx = e.clientX - startPoint.x;
                  var dy = e.clientY - startPoint.y;

                  var oldMapPoint = map.latLngToLayerPoint(originalLatLng);
                  var newMapPoint = oldMapPoint.add([dx, dy]);
                  var newLatLng = map.layerPointToLatLng(newMapPoint);

                  popup.setLatLng(newLatLng);
                  container.style.transform = ''; // Reset CSS transform

                  // Update the original LatLng for subsequent drags
                  originalLatLng = newLatLng;
              }
          }

          L.DomEvent.on(document, 'mousemove', onMove);
          L.DomEvent.on(document, 'mouseup', onUp);
      });
  }

  // --- Utility function to get Country Initials ---
  function getCountryInitials(countryString) {
      if (countryString.includes('Albania üá¶üá± / N. Macedonia üá≤üá∞')) return 'AL/MK';
      if (countryString.includes('BiH üáßüá¶ / Serbia üá∑üá∏')) return 'BiH/SRB';
      if (countryString.includes('Kosovo')) return 'KS';
      if (countryString.includes('Albania') && !countryString.includes('/')) return 'AL';
      if (countryString.includes('Serbia') && !countryString.includes('/')) return 'SRB';
      if (countryString.includes('BiH') && !countryString.includes('/')) return 'BiH';
      if (countryString.includes('Montenegro')) return 'ME';
      if (countryString.includes('N. Macedonia') && !countryString.includes('/')) return 'MK';
      return 'WB'; 
  }

  // -------- Project Data (All translated to English) --------
  const projects = [
    // --- KOSOVO (KS) ---
    { name: "Community Fire Guardians", country: "Kosovo üáΩüá∞", icon: "üî•", coords: [42.4503, 21.2800], radius: 35000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> Community Fire Guardians: Empowering Youth in Landscape Fire Management and Digital Monitoring", "<strong>Area:</strong> Kamenica, Lipjan, and Suhareka (Municipalities)", "<strong>Lead:</strong> Peer Educators Network (PEN) (NGO)", "<strong>Goal:</strong> Foster youth responsibility and proactive behavior in fire prevention and management efforts.", "<strong>Outcome:</strong> Successful creation and launch of the Landscape Fire Monitoring App; Increased youth awareness and involvement (240 participants).", "<strong>Priority:</strong> Innovative Approaches in LFM, Capacity Building."] },
    { name: "Wildfire Resilience and Landscape Management Initiative (WRLMI)", country: "Kosovo üáΩüá∞", icon: "üõ°Ô∏è", coords: [42.9230, 20.8655], radius: 20000, zoom: 12, isCrossBorder: false, details: ["<strong>Title:</strong> Wildfire Resilience and Landscape Management Initiative (WRLMI)", "<strong>Area:</strong> North Mitrovica and Zveƒçan (Municipalities)", "<strong>Lead:</strong> International Business College Mitrovica (IBC-M) (College/NGO)", "<strong>Goal:</strong> To decrease the risk of wildfires by connecting all stakeholders with a modern and inclusive approach.", "<strong>Outcome:</strong> Capacity development for the Fire department; Training for at least 8 firefighters to use modern technologies like drones, GIS, and interactive maps; Development of Action Plans.", "<strong>Priority:</strong> Traditional LFM Knowledge, Innovative Approaches in LFM, Capacity Building."] },
    // --- ALBANIA (AL) ---
    { name: "Fire Free ‚Äì Reducing the Risk of Fires in Gramsh", country: "Albania üá¶üá±", icon: "üå≤", coords: [40.8667, 20.1833], radius: 15000, zoom: 12, isCrossBorder: false, details: ["<strong>Title:</strong> Fire Free ‚Äì Reducing the risk of fires in landscapes in the municipality of Gramsh, Albania", "<strong>Area:</strong> Municipality of Gramsh (Central Albania, second in the country for forest area)", "<strong>Lead:</strong> Association Together for Life (TFL) (NGO)", "<strong>Goal:</strong> Enhancing community engagement and increasing the capacities of local government for LFM practices to reduce the risks of fires.", "<strong>Outcome:</strong> The community should raise its capacities; The local government should increase its capacity to assess fire risks and establish local strategies/plans for risk reduction.", "<strong>Priority:</strong> Capacity Building, Prevention, Preparedness, and Restoration."] },
    // --- CROSS-BORDER AL/MK ---
    { name: "CYCLE-FIRE: Community-Youth Landscape Fire Reduction (AL/MK)", country: "Albania üá¶üá± / N. Macedonia üá≤üá∞", icon: "‚ôªÔ∏è", coords: [41.5600, 20.3000], radius: 35000, zoom: 10, isCrossBorder: true, details: ["<strong>Title:</strong> CYCLE-FIRE: Community-Youth-Centered Landscape Fire Reduction in Albania and Northern Macedonia", "<strong>Area:</strong> Bulqiz√´ & Burrel (Albania), Gostivar & Mavrova and Rostusha (N. Macedonia)", "<strong>Lead:</strong> Shoqata Kreo (Albania, NGO) & Organized Youth Association (OYA) (N. Macedonia)", "<strong>Goal:</strong> Prevention of Landscape Fires in critical areas by mobilizing youth and community leaders, combining traditional and modern practices.", "<strong>Outcome:</strong> Enhanced capacity and interaction of 14 community leaders (7 from each country); Strengthened cross-border cooperation and knowledge exchange.", "<strong>Priority:</strong> Traditional LFM Knowledge, Innovative Approaches in LFM, Capacity Building."] },
    // --- CROSS-BORDER BiH/SRB ---
    { name: "Cross-border Fire Prevention Initiative (BiH/SRB)", country: "BiH üáßüá¶ / Serbia üá∑üá∏", icon: "üõ∞Ô∏è", coords: [43.9000, 19.3300], radius: 35000, zoom: 10, isCrossBorder: true, details: ["<strong>Title:</strong> Cross-border fire prevention initiative in National Park Tara and Protected Landscape Trebeviƒá", "<strong>Area:</strong> Protected Landscape Trebeviƒá (Sarajevo Canton, BiH) and National Park Tara (Republic of Serbia).", "<strong>Lead:</strong> FEA - Forestry and Environmental Action (BiH, NGO)", "<strong>Goal:</strong> Implement advanced fire detection and management technologies (thermal cameras, sensors, drones) and pilot satellite technologies.", "<strong>Outcome:</strong> Establishment of the foundation for using advanced technologies; Enhanced cross-border cooperation; Education and awareness of local communities.", "<strong>Priority:</strong> Innovative Approaches in LFM, Cross-Border Cooperation."] },
    // --- BOSNIA-HERZEGOVINA (BiH) ---
    { name: "YOUTH ON FIRE", country: "BiH üáßüá¶ (Republika Srpska)", icon: "üßë‚Äçüöí", coords: [45.0967, 17.5253], radius: 15000, zoom: 12, isCrossBorder: false, details: ["<strong>Title:</strong> YOUTH ON FIRE: Fostering of Improving the Regional Environmental system by using local fire management", "<strong>Area:</strong> Srbac Municipality, Lijevƒçe polje (critical agricultural region)", "<strong>Lead:</strong> Association \"C.E.Z.A.R.\" Srbac (youth organization)", "<strong>Goal:</strong> Actively engage local youth and communities in LFM by integrating traditional fire prevention knowledge with modern practices.", "<strong>Outcome:</strong> Distribution of 30 fire extinguishers and training to high-risk households; Improved capacity for fire management; Preservation and integration of traditional and modern knowledge.", "<strong>Priority:</strong> Traditional LFM Knowledge, Capacity Building, Prevention, Preparedness, and Restoration."] },
    { name: "FireSafe Jezero", country: "BiH üáßüá¶ (Republika Srpska)", icon: "üî•üìÑ", coords: [44.3500, 17.1680], radius: 10000, zoom: 13, isCrossBorder: false, details: ["<strong>Title:</strong> FireSafe Jezero: Comprehensive Landscape Fire Prevention and Education Initiative", "<strong>Area:</strong> Jezero municipality (tourist destination facing fire hazards at picnic sites)", "<strong>Lead:</strong> The Municipality of Jezero (Local Government)", "<strong>Goal:</strong> Enhance fire safety and preparedness through comprehensive prevention measures and education.", "<strong>Outcome:</strong> Creation of standardized fire safety documents (Analysis, Rulebook, Evacuation Plan); Increased awareness via informative signs with QR codes.", "<strong>Priority:</strong> Traditional LFM Knowledge, Innovative Approaches in LFM, and Capacity Building."] },
    // --- SERBIA (SRB) ---
    { name: "FireGuard Network", country: "Serbia üá∑üá∏", icon: "üåê", coords: [43.8500, 20.0000], radius: 25000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> FireGuard Network", "<strong>Area:</strong> City of U≈æice and Municipality of Po≈æega (Western Serbia, high fire-risk area)", "<strong>Lead:</strong> The Association of Private Forest Owners \"Bor\" (APFO Bor) (NGO)", "<strong>Goal:</strong> Improve the connection between local communities and official bodies implementing LFM through the active involvement of civil society.", "<strong>Outcome:</strong> Establishing a civil network of trained citizens; Initiating a dialogue among stakeholders to improve the planning of firebreaks in Serbia.", "<strong>Priority:</strong> Traditional LFM Knowledge, Innovative Approaches in LFM, Capacity Building."] },
    { name: "FireGuard: Wildfire Resilience and Management for Serbia's Protected Areas", country: "Serbia üá∑üá∏", icon: "üìπ", coords: [43.3200, 21.8950], radius: 5000, zoom: 14, isCrossBorder: false, details: ["<strong>Title:</strong> FireGuard: Wildfire Resilience and Management for Serbia's Protected Areas", "<strong>Area:</strong> Lalinaƒçka Slatina Nature Monument and other protected areas", "<strong>Lead:</strong> Biological Society \"Dr Sava Petroviƒá\" (BSDSP) (NGO)", "<strong>Goal:</strong> Improve wildfire resilience and management in Serbia's protected areas through advanced detection systems, community engagement, and capacity building.", "<strong>Outcome:</strong> Enhanced early fire detection capabilities through maintenance/upgrade of thermal imaging cameras; Development of the first-ever comprehensive manual on wildfire management in protected areas.", "<strong>Priority:</strong> Innovative Approaches in LFM (detection systems), Capacity Building."] },
    // --- MONTENEGRO (ME) ---
    { name: "Empowering Citizens in Sustainable Fire Management", country: "Montenegro üá≤üá™", icon: "üöÅ", coords: [42.7500, 19.3000], radius: 30000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> Empowering Citizens in transparent, accountable and sustainable forest fire management", "<strong>Area:</strong> Targets three specific municipalities in Montenegro", "<strong>Lead:</strong> NU Organization KOD (NGO)", "<strong>Goal:</strong> To strengthen local communities to actively participate in responsible forest fire management by integrating traditional knowledge with innovative techniques.", "<strong>Outcome:</strong> Development and utilization of GIS-based fire risk maps; Reforestation of fire-prone areas using drones equipped with self-germinating seed balls.", "<strong>Priority:</strong> Traditional LFM Knowledge, Innovative Approaches (Drones/GIS), Capacity Building."] },
    { name: "Strengthening the response to landscape fires", country: "Montenegro üá≤üá™", icon: "üö®", coords: [42.9000, 18.9000], radius: 30000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> Strengthening the response to landscape fires", "<strong>Area:</strong> Niksic, Pluzine, and Savnik (Montenegro)", "<strong>Lead:</strong> Association of young ecologists of Niksic (NGO)", "<strong>Goal:</strong> To contribute to reducing the risk of wildfires in Montenegro; Increase cooperation between NGOs and institutions.", "<strong>Outcome:</strong> Procurement and distribution of three drones for preventive terrain monitoring; Signing a Memorandum of Cooperation and Understanding among institutions and NGOs.", "<strong>Priority:</strong> Innovative Approaches in LFM, Capacity Building, Prevention, Preparedness, and Restoration."] },
    // --- NORTH MACEDONIA (MK) ---
    { name: "EcoFire Youth Ambassadors at Lake Ohrid", country: "N. Macedonia üá≤üá∞", icon: "üèõÔ∏è", coords: [41.0833, 20.8000], radius: 25000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> EcoFire Youth Ambassadors: Integrating Fire Management, Heritage, and Sustainability at Lake Ohrid", "<strong>Area:</strong> Lake Ohrid, Ohrid, Struga, Debrca (UNESCO World Heritage site)", "<strong>Lead:</strong> Association for Ecology ‚ÄúEkomenlog‚Äù Ohrid (NGO)", "<strong>Goal:</strong> To enhance fire management capacity and long-term sustainability by engaging youth and the community toward the preservation of the cultural heritage of Lake Ohrid.", "<strong>Outcome:</strong> Establishment of 10 kilometers of eco-friendly firebreaks; Training of 50 youth ambassadors; Development and launch of a mobile app for participatory fire monitoring.", "<strong>Priority:</strong> Innovative Approaches in LFM, Capacity Building, Prevention, Traditional/Cultural approaches."] },
    { name: "Promoting Fire-Safe Farming Practices in Novaci Municipality", country: "N. Macedonia üá≤üá∞", icon: "üåæ", coords: [41.0419, 21.4561], radius: 10000, zoom: 13, isCrossBorder: false, details: ["<strong>Title:</strong> Promoting fire-safe farming practices in Novaci Municipality", "<strong>Area:</strong> Novaci Municipality (southern Pelagonija Statistical Region, characterized by arable land)", "<strong>Lead:</strong> Resource Environmental Center (REC) (NGO)", "<strong>Goal:</strong> To promote and establish the foundation for implementing farming practices that will reduce available fuels and the risk of ignition.", "<strong>Outcome:</strong> Adoption of safe farming practices and best-practice guidelines; Planting of 500 meters length of green firebelts using fire-retardant plant species along roads.", "<strong>Priority:</strong> Capacity Building, Prevention, Preparedness, and Restoration."] },
    { name: "Strengthening Capacities of Local Stakeholders for Improved Resilience in Wildfire Management", country: "N. Macedonia üá≤üá∞", icon: "üí™", coords: [41.6000, 22.3800], radius: 35000, zoom: 11, isCrossBorder: false, details: ["<strong>Title:</strong> Strengthening Capacities of Local Stakeholders for Improved Resilience in Wildfire Management", "<strong>Area:</strong> Konce, Karbinci, Radovis, and Stip (Plaƒçkovica region)", "<strong>Lead:</strong> Association Local Action Group (LAG) PLACKOVICA (NGO)", "<strong>Goal:</strong> To enhance the resilience of the four target municipalities to wildfire risks by strengthening the capacities of local stakeholders and improving coordination.", "<strong>Outcome:</strong> Establishment of Local Structures (Committees/Task Forces); Development and adoption of a Regional Wildfire Management Plan for the four municipalities.", "<strong>Priority:</strong> Capacity Building, Prevention, Preparedness, and Restoration."] }
  ];

  // --- Map Initialization ---
  const map = L.map('map', { zoomControl: true }).setView([43.4, 20.3], 6);
  
  // --- Base Maps Definition (Leaflet Tiles) ---
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 });
  const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'Map data: ¬© OpenStreetMap contributors, SRTM | Map style: ¬© OpenTopoMap (CC-BY-SA)', maxZoom: 17 });
  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community', maxZoom: 19 });
  
  // D. Country Borders Layer (Overlay - Using a common WMS for visualization)
  const borders = L.layerGroup([
      L.tileLayer.wms('https://ows.terrestris.de/osm/service?', {
          layers: 'OSM-WMS',
          format: 'image/png',
          transparent: true,
          attribution: "Country Borders via WMS"
      }),
  ]);

  // Default to Streetmap
  osm.addTo(map);
  
  // Attach the drag logic to the map's popup open event
  map.on('popupopen', makePopupDraggable);

  // Define Layers for the Control
  const baseLayers = {
      "1. Streetmap": osm,
      "2. Geophysical": topo,
      "3. Satellite": satellite
  };
  
  const overlayLayers = {
      "Show Country Borders": borders 
  };

  // Add the Layer Control (Background Selector + Overlay for Borders)
  L.control.layers(baseLayers, overlayLayers, {
      collapsed: true,
      position: 'topleft' 
  }).addTo(map);

  let markers = [];
  let activeCircle = null; 

  // --- Utility function to get Country Initials ---
  function getCountryInitials(countryString) {
      if (countryString.includes('Albania üá¶üá± / N. Macedonia üá≤üá∞')) return 'AL/MK';
      if (countryString.includes('BiH üáßüá¶ / Serbia üá∑üá∏')) return 'BiH/SRB';
      if (countryString.includes('Kosovo')) return 'KS';
      if (countryString.includes('Albania') && !countryString.includes('/')) return 'AL';
      if (countryString.includes('Serbia') && !countryString.includes('/')) return 'SRB';
      if (countryString.includes('BiH') && !countryString.includes('/')) return 'BiH';
      if (countryString.includes('Montenegro')) return 'ME';
      if (countryString.includes('N. Macedonia') && !countryString.includes('/')) return 'MK';
      return 'WB'; 
  }

  // Helper for custom icons to include Initials and Badge
  function iconBadge(emoji, countryString, isCrossBorder){
    const initials = getCountryInitials(countryString);
    const bg = isCrossBorder ? '#F0A500' : '#2E8B57'; 

    const html = `<div class="country-marker">
                    <div class="initials">${initials}</div>
                    <div class="badge" style="background:${bg};">${emoji}</div>
                  </div>`;
                  
    return L.divIcon({
      html: html,
      className:'x', 
      iconSize:[40, 60],     
      iconAnchor:[20, 60],    
      popupAnchor:[0, -45]    
    });
  }

  // Generate standard Popup HTML
  function popupHtml(proj){
    const detailsList = proj.details.map(x=>`<li>${x}</li>`).join('');
    const type = proj.isCrossBorder ? 'Cross-Border Project ü§ù' : 'Single-Country Project ‚û°Ô∏è';
    return `<div class="popup"><div class="title">${proj.icon} ${proj.name}</div>
            <div class="subtitle">${proj.country} | ${type}</div>
            <div class="details"><ul>${detailsList}</ul></div></div>`;
  }

  // Add markers to the map and bind Popups
  projects.forEach((proj,i)=>{
    const m = L.marker(proj.coords,{icon:iconBadge(proj.icon, proj.country, proj.isCrossBorder)});
    
    m.bindPopup(popupHtml(proj),{
        popupAnchor: [0, -10],
        className: 'draggable-popup'
    });
    
    m.addTo(map);
    markers.push(m);
    
    // Custom event to handle click on marker
    m.on('click', function (e) {
        // Handle Map Zoom and Delineation
        showDelineation(e.latlng, proj.radius, proj.zoom);
        // Highlight in sidebar
        highlightSidebar(i);
    });
  });

  // Function to show/update the approximate area delineation (Circle)
  function showDelineation(latlng, radius, zoom){
    if (activeCircle) {
        map.removeLayer(activeCircle);
    }

    activeCircle = L.circle(latlng, {
        color: '#00BFFF',         
        fillColor: '#00BFFF',
        fillOpacity: 0.1,
        weight: 2,
        radius: radius            
    }).addTo(map);

    map.fitBounds(activeCircle.getBounds(), {
        padding: [20, 20],
        maxZoom: zoom 
    });
  }

  // Function to clear delineation when popup is closed or map is clicked
  function clearDelineation() {
      if (activeCircle) {
          map.removeLayer(activeCircle);
          activeCircle = null;
      }
      document.querySelectorAll('.loc').forEach(e => e.classList.remove('active'));
  }
  
  // Clear delineation on map click and popup close
  map.on('popupclose', clearDelineation);
  map.on('click', clearDelineation);


  // Create the project list in the sidebar
  const projectListDiv = document.getElementById('project-list');
  projects.forEach((proj, i) => {
    const el = document.createElement('div');
    el.classList.add('loc');
    if (proj.isCrossBorder) el.classList.add('cross-border');
    el.setAttribute('data-i', i);
    el.innerHTML = `
      <div class="t">${proj.icon} ${proj.name}</div>
      <div class="d">${proj.country}</div>
      <div class="org small">${proj.details[3].replace('<strong>Goal:</strong> ', '').substring(0, 75)}...</div>
    `;
    projectListDiv.appendChild(el);
  });

  // Helper function to highlight sidebar element
  function highlightSidebar(i) {
      document.querySelectorAll('.loc').forEach(e => e.classList.remove('active'));
      const active = document.querySelector(`.loc[data-i="${i}"]`); 
      if (active) active.classList.add('active');
  }

  // Sidebar bindings (click event)
  document.querySelectorAll('.loc').forEach((el)=>{
    el.addEventListener('click', ()=>{
      const i=+el.dataset.i;
      const proj = projects[i];
      
      // Clear any previous delineation/popup
      clearDelineation();

      // 1. Show Delineation and Zoom
      showDelineation(proj.coords, proj.radius, proj.zoom);
      
      // 2. Open Popup
      markers[i].openPopup();
      
      // 3. Highlight Sidebar
      highlightSidebar(i);
    });
  });

  // Fit view to all markers
  function fitAll(){
    if (markers.length === 0) return;
    clearDelineation(); 
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }

  // Ensure Leaflet knows final size and call fitAll on load
  window.addEventListener('load', ()=>{
    map.invalidateSize(true);
    fitAll();
  });
  window.addEventListener('resize', ()=> map.invalidateSize(true));
</script>
</body>
</html>
